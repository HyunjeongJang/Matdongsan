<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="freeBoardMapper">

    <resultMap type="freeBoard" id="fBoardResultSet">
        <result column="FREE_BNO" property="boardNo"/>
        <result column="MEMBER_NO" property="memberNo"/>
        <result column="BOARD_TITLE" property="boardTitle"/>
        <result column="PROFILE_IMAGE" property="profileImage"/>
        <result column="BOARD_WRITER" property="boardWriter"/>
        <result column="BOARD_CONTENT" property="boardContent"/>
        <result column="BOARD_DATE" property="boardDate"/>
        <result column="BOARD_AREA" property="boardArea"/>
        <result column="STATUS" property="status"/>
        <result column="COUNT" property="count"/>
    </resultMap>

    <resultMap id="replyResultSet" type="reply">
        <result column="REPLY_NO" property="replyNo"/>
        <result column="MEMBER_NO" property="memberNo"/>
        <result column="PROFILE_IMAGE" property="profileImage"/>
        <result column="FREE_BNO" property="freeBno"/>
        <result column="REPLY_CONTENT" property="replyContent"/>
        <result column="REPLY_DATE" property="replyDate"/>
        <result column="STATUS" property="status"/>
    </resultMap>

    <resultMap id="reportResultSet" type="report">
        <result column="REPORT_NO" property="reportNo"/>
        <result column="FREE_BNO" property="reportFno"/>
        <result column="MEMBER_NO" property="reportedPerson"/>
        <result column="REPORT_USER_NO" property="reporter"/>
        <result column="REPORT_CONTENT" property="reportContent"/>
    </resultMap>


    <insert id="insertFboard" parameterType="freeBoard">
        INSERT INTO FREE_BOARD (FREE_BNO, MEMBER_NO, BOARD_TITLE, BOARD_WRITER, BOARD_CONTENT, BOARD_AREA)
        VALUES (SEQ_FREE_BNO.nextval, #{memberNo}, #{boardTitle}, #{boardWriter}, #{boardContent}, #{boardArea})
    </insert>

    <select id="selectFreeList" parameterType="Map" resultMap="fBoardResultSet">
        SELECT *
        FROM FREE_BOARD
        WHERE STATUS='Y'
            <if test="!state.isBlank()">
                AND BOARD_AREA = #{state}
            </if>
            <if test="!search.isBlank()">
                AND (
                    BOARD_TITLE like '%' || #{search} || '%'
                    OR
                    BOARD_WRITER like '%' || #{search} || '%'
                    OR
                    BOARD_CONTENT like '%' || #{search} || '%'
                )
            </if>
    </select>

    <select id="detailFreeBoard" parameterType="int" resultMap="fBoardResultSet">
        SELECT
            FREE_BNO,
            BOARD_TITLE,
            F.MEMBER_NO,
            BOARD_WRITER,
            PROFILE_IMAGE,
            BOARD_AREA,
            BOARD_CONTENT,
            BOARD_DATE
        FROM FREE_BOARD F
        LEFT JOIN MEMBER M ON F.MEMBER_NO = M.MEMBER_NO
        WHERE F.STATUS = 'Y'
          AND FREE_BNO = #{fno}
    </select>

    <insert id="insertReply" parameterType="Reply">
        INSERT INTO REPLY (REPLY_NO, MEMBER_NO, FREE_BNO, REPLY_CONTENT)
        VALUES (SEQ_REP_NO.nextval, #{memberNo}, #{freeBno}, #{replyContent})
    </insert>

    <select id="selectReplyList" parameterType="int" resultMap="replyResultSet">
        SELECT
            REPLY_NO,
            FREE_BNO,
            R.MEMBER_NO,
            PROFILE_IMAGE,
            NICKNAME,
            REPLY_CONTENT,
            REPLY_DATE
        FROM REPLY R
        LEFT JOIN MEMBER M ON M.MEMBER_NO = R.MEMBER_NO
        WHERE R.STATUS = 'Y'
            AND FREE_BNO = ${freeBno}
        ORDER BY R.REPLY_DATE
    </select>

    <update id="deletePost" parameterType="int">
        UPDATE FREE_BOARD
        SET STATUS = 'N'
        WHERE FREE_BNO = #{fno}
    </update>

    <update id="updatePost" parameterType="freeBoard">
        UPDATE FREE_BOARD
        SET BOARD_TITLE = '${boardTitle}',
            BOARD_CONTENT = '${boardContent}'
        WHERE FREE_BNO = '${boardNo}'
    </update>

    <insert id="insertReport" parameterType="report">
        INSERT INTO REPORT (REPORT_NO, FREE_BNO, MEMBER_NO, REPORT_USER_NO, REPORT_CONTENT)
        VALUES (SEQ_REP_NO.NEXTVAL, ${reportFno}, ${reportedPerson}, ${reporter}, '${reportContent}')
    </insert>

    <update id="deleteReply" parameterType="reply">
        UPDATE REPLY
        SET STATUS = 'N'
        WHERE FREE_BNO = ${freeBno}
            AND REPLY_NO = ${replyNo}
            AND MEMBER_NO = ${memberNo}
    </update>
</mapper>

