<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="boardMapper">
    <resultMap type="QBoard" id="qBoardResultSet">
        <result column="QNA_BNO" property="qnaBno"/>
        <result column="MEMBER_NO" property="memberNo"/>
        <result column="P_BNO" property="parentBno"/>
        <result column="QNA_TITLE" property="qnaTitle"/>
        <result column="QNA_CONTENT" property="qnaContent"/>
        <result column="QNA_DATE" property="qnaDate"/>
        <result column="COUNT" property="count"/>
        <result column="STATUS" property="status"/>
        <result column="QNA_AREA" property="qnaArea"/>
        <result column="BOARD_CD" property="boardCd"/>
        <result column="NICKNAME" property="qnaWriter"/>
        <result column="QNA_DEPTH" property="depth"/>
    </resultMap>


    <resultMap type="boardType" id="boardTypeResultSet">
        <id column="BOARD_CD" property="boardCd"/>
        <result column="BOARD_NAME" property="boardName"/>
    </resultMap>

    <resultMap type="FBoard" id="fBoardResultSet">
        <result column="FREE_BNO" property="freeBno"/>
        <result column="MEMBER_NO" property="memberNo"/>
        <result column="BOARD_TITLE" property="boardTitle"/>
        <result column="BOARD_WRITER" property="boardWriter"/>
        <result column="BOARD_CONTENT" property="boardContent"/>
        <result column="BOARD_DATE" property="boardDate"/>
        <result column="BOARD_AREA" property="boardArea"/>
        <result column="STATUS" property="status"/>
        <result column="BOARD_CD" property="boardCd"/>
        <result column="COUNT" property="count"/>
    </resultMap>


    <select id="selectList" resultMap="qBoardResultSet">
        SELECT QNA_BNO,
               M.MEMBER_NO,
               M.NICKNAME,
               P_BNO,
               QNA_TITLE,
               QNA_DATE,
               QNA_DEPTH,
               COUNT
        FROM QNA_BOARD B
                 LEFT JOIN MEMBER M ON (M.MEMBER_NO = B.MEMBER_NO)
        WHERE B.STATUS = 'Y'
          AND BOARD_CD = #{boardCode}
        START WITH P_BNO IS NULL
        CONNECT BY PRIOR QNA_BNO = P_BNO
        ORDER SIBLINGS BY QNA_BNO ASC
    </select>

    <select id="selectListCount" resultType="int">
        SELECT COUNT(*)
        FROM QNA_BOARD
        WHERE STATUS = 'Y'
          AND BOARD_CD = #{boardCode}
    </select>

    <select id="selectBoardTypeList" resultMap="boardTypeResultSet">
        SELECT *
        FROM BOARD_TYPE
        ORDER BY BOARD_CD
    </select>

    <insert id="insertQboard" parameterType="QBoard">
        INSERT INTO QNA_BOARD(QNA_BNO, MEMBER_NO, QNA_TITLE, QNA_CONTENT)
        VALUES (SEQ_QNA_BNO.NEXTVAL, #{memberNo}, #{qnaTitle}, #{qnaContent})
    </insert>

    <select id="searchList" resultMap="qBoardResultSet">
        SELECT
        QNA_BNO,
        Q.MEMBER_NO,
        P_BNO,
        QNA_TITLE,
        QNA_CONTENT,
        M.NICKNAME,
        QNA_DATE
        FROM QNA_BOARD Q
        LEFT JOIN MEMBER M ON (M.MEMBER_NO = Q.MEMBER_NO)
        WHERE Q.STATUS='Y' AND BOARD_CD = #{boardCode}
        <if test='keyword != null and keyword != ""'>
            AND
            <choose>
                <when test="condition == 'title'">
                    QNA_TITLE LIKE '%${keyword}%'
                </when>
                <when test="condition == 'content'">
                    QNA_CONTENT LIKE '%${keyword}%'
                </when>
            </choose>
        </if>
        START WITH P_BNO IS NULL
        CONNECT BY PRIOR QNA_BNO = P_BNO
        ORDER SIBLINGS BY QNA_BNO ASC
    </select>

    <select id="searchListCount" resultType="int">
        SELECT COUNT(*)
        FROM QNA_BOARD
        WHERE STATUS = 'Y' AND BOARD_CD = #{boardCode}
        <if test='keyword != null and keyword != ""'>
            AND
            <choose>
                <when test="condition == 'title'">
                    QNA_TITLE LIKE 'f%${keyword}%'
                </when>
                <when test="condition == 'content'">
                    QNA_CONTENT LIKE '%${keyword}%'
                </when>
            </choose>
        </if>
    </select>


    <select id="selectQboard" parameterType="int" resultMap="qBoardResultSet">
        SELECT QNA_BNO,
               COUNT,
               QNA_TITLE,
               QNA_CONTENT,
               M.NICKNAME,
               QNA_DATE
        FROM QNA_BOARD Q
        LEFT JOIN MEMBER M ON (M.MEMBER_NO = Q.MEMBER_NO)
        WHERE Q.STATUS = 'Y'
          AND QNA_BNO = #{qBno}

    </select>

    <update id="increaseCount" parameterType="int">
        UPDATE QNA_BOARD
        SET COUNT = COUNT + 1
        WHERE QNA_BNO = #{qBno}
    </update>

    <insert id="insertAnswer" parameterType="QBoard">
        INSERT INTO QNA_BOARD(QNA_BNO, MEMBER_NO, QNA_TITLE, QNA_CONTENT, P_BNO, QNA_DEPTH)
        VALUES (SEQ_QNA_BNO.NEXTVAL, #{memberNo}, #{qnaTitle}, #{qnaContent}, ${parentBno} + 1, ${depth} + 1)
    </insert>


<!-- ################################ 커뮤니티 자유게시판  ################################-->

    <select id="selectFlist" resultMap="fBoardResultSet">
        SELECT
            FREE_BNO,
            MEMBER_NO,
            BOARD_TITLE,
            BOARD_WRITER,
            BOARD_CONTENT,
            BOARD_DATE,
            BOARD_AREA
        FROM FREE_BOARD
        WHERE STATUS = 'Y' AND BOARD_CD = #{boardCode}
    </select>

    <select id="selectFlistCount" resultType="int">
        SELECT COUNT(*)
        FROM FREE_BOARD
        WHERE STATUS = 'Y' AND BOARD_CD = #{boardCode}
    </select>

    <select id="searchFlist" resultMap="fBoardResultSet">
        SELECT
        FREE_BNO,
        MEMBER_NO,
        BOARD_TITLE,
        BOARD_WRITER,
        BOARD_CONTENT,
        BOARD_DATE,
        BOARD_AREA
        FROM FREE_BOARD
        WHERE STATUS='Y' AND
        <if test='keyword != null and keyword != ""'>
            AND
            <choose>
                <when test="condition == 'title'">
                    BOARD_TITLE LIKE '%${keyword}%'
                </when>
                <when test="condition == 'content'">
                    BOARD_CONTENT LIKE '%${keyword}%'
                </when>
            </choose>
        </if>
        ORDER BY FREE_BNO ASC
    </select>

    <select id="searchFlistCount" resultType="int">
        SELECT COUNT(*)
        FROM FREE_BOARD
        WHERE STATUS = 'Y' AND BOARD_CD = #{boardCode}
        <if test='keyword != null and keyword != ""'>
            AND
            <choose>
                <when test="condition == 'title'">
                     BOARD_TITLE LIKE 'f%${keyword}%'
                </when>
                <when test="condition == 'content'">
                    BOARD_CONTENT LIKE '%${keyword}%'
                </when>
            </choose>
        </if>
    </select>

    <select id="selectAnswer" parameterType="int" resultMap="qBoardResultSet">
        SELECT QNA_BNO,
               QNA_TITLE,
               QNA_CONTENT,
               M.NICKNAME
        FROM QNA_BOARD Q
                 LEFT JOIN MEMBER M ON (M.MEMBER_NO = Q.MEMBER_NO)
        WHERE Q.STATUS = 'Y'
          AND QNA_BNO = #{qBno}


    </select>
</mapper>

